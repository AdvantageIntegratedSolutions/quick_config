function BaseConnect(t){this.config=t,this.inverseTables=BaseHelpers.inverseTables(t.tables),this.apptoken=t.token,this.async=t.async||!1,this.databaseId=t.databaseId,this.serverSide=t.serverSide||!1,this.realm=t.realm,this.post=function(t){var e=t.type||"API",n=e+"_"+t.action,r=this.buildPostData(t.dbid,t),i="";return i=t.dbid?this.config&&"main"!=t.dbid?t.dbid==this.databaseId?this.databaseId:this.config.tables[t.dbid].dbid:t.dbid:this.databaseId,this.xmlPost(i,n,r)},this.generateQuickbaseQuery=function(t){var e=[],n=function(t,e){return"{'"+t+"'.EX.'"+e+"'}"},r=function(t,e){for(var n=Object.keys(e),r=[],i=0;i<n.length;i++){var a=n[i],s=e[a],o="";if("in"==a){var r=[];s.forEach(function(e){r.push("{'"+t+"'.EX.'"+e+"'}")}),o="("+r.join("OR")+")"}else o="{'"+t+"'."+a+".'"+s+"'}";r.push(o)}return r.join("AND")},i=function(t,e){var i=[];return e.forEach(function(t){var e=Object.keys(t)[0],a=t[e];if("object"==typeof a){var t=r(e,a);i.push(t)}else{var t=n(e,a);i.push(t)}}),"("+i.join("OR")+")"};for(key in t){var a=t[key],s="";s="or"==key?i(key,a):"object"==typeof a?r(key,a):n(key,t[key]),e.push(s)}return e=e.join("AND")},this.replaceFieldNames=function(t,e){var n=this.config;return t=t.split(/(AND|OR)/).map(function(t){if("AND"!=t&&"OR"!=t){var r=t.match(/\{'*(.*)'\..*'/)[1];if(isNaN(r)){var i=n.tables[e][r];t=t.replace(r,i)}}return t}),t.join("")},this.replaceOptionFieldNames=function(t,e){var n=this.config;return t=t.split("."),t=t.map(function(t){if(isNaN(t)){var r=n.tables[e][t];return r}return t}),t.join(".")},this.handleXMLCharacters=function(t){return t.replace(/&/g,"&").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&apos;")},this.buildPostData=function(t,e){var n=["<qdbapi>"];this.apptoken&&n.push(this.createParameter("apptoken",this.apptoken));for(key in e.params){var r=e.params[key];"clist"==key||"slist"==key||"options"==key?("object"==typeof r&&(r=r.join(".")),!this.config||"clist"!=key&&"slist"!=key||r&&(r=this.replaceOptionFieldNames(r,t))):"query"==key&&(r=this.generateQuickbaseQuery(r),this.config&&(r=this.replaceFieldNames(r,t)),key="query"),r&&n.push(this.createParameter(key,r))}for(field in e.fieldParams){if(this.config)var i=this.config.tables[t][field];else var i=field;var a=this.handleXMLCharacters(e.fieldParams[field]);n.push(this.createFieldParameter(i,a))}for(key in e.fidParams)n.push(this.createFidParameter(key,e.fidParams[key]));return e.csvData&&n.push(this.createCSVParameter(e.csvData)),n.push("</qdbapi>"),n=n.join(""),this.serverSide?{xml:n}:n},this.getNode=function(t,e){return $(t).find(e).text()},this.getRecords=function(t,e){for(var n=$(e).find("records").find("record"),r=[],i=0;i<n.length;i++){var a=n[i],s=$(a).find("f");a={};for(var o=0;o<s.length;o++){var d=s[o],h=parseInt($(d).attr("id"));if(""!=$(d).find("url").text())var u=$(d).find("url").text(),c=u.split("/"),f=c[c.length-1],l={filename:f,url:u};else var l=$(d).text();if(this.config){var p=this.inverseTables[t];p[h]&&(h=p[h.toString()],a[h]=l)}else a[h]=l}r.push(a)}return r},this.getRids=function(t){for(var e=$(t).find("records").find("record"),n=[],r=0;r<e.length;r++){var i=e[r];n.push($(i).find('f[id="3"]').text())}return n},this.getNewRids=function(t){for(var e=$(t).find("rids").find("rid"),n=[],r=0;r<e.length;r++){var i=parseInt($(e[r]).text());n.push(i)}return n},this.getFields=function(t){for(var e=$(t).find("fields").find("field"),n={},r=0;r<e.length;r++){var i=e[r],a={label:$(i).find("label").text(),nowrap:$(i).find("nowrap").text(),bold:$(i).find("bold").text(),required:$(i).find("required").text(),appears_by_default:$(i).find("appears_by_default").text(),find_enabled:$(i).find("find_enabled").text(),allow_new_choices:$(i).find("allow_new_choices").text(),sort_as_given:$(i).find("sort_as_given").text(),carrychoices:$(i).find("carrychoices").text(),foreignkey:$(i).find("foreignkey").text(),unique:$(i).find("unique").text(),doesdatacopy:$(i).find("doesdatacopy").text(),fieldhelp:$(i).find("fieldhelp").text(),display_user:$(i).find("display_user").text(),default_kind:$(i).find("default_kind").text()},s=$(i).find("choices").find("choice");if(s.length>0){for(var o=[],d=0;d<s.length;d++){var h=$(s[d]).text();o.push(h)}a.choices=o}n[$(i).attr("id")]=a}return n},this.getReports=function(t){for(var e=$(t).find("queries").find("query"),n={},r=0;r<e.length;r++){var i=e[r],a={name:$(i).find("qyname").text(),type:$(i).find("qytype").text(),criteria:$(i).find("qycrit").text(),clist:$(i).find("qyclst").text(),slist:$(i).find("qyslst").text(),options:$(i).find("qyopts").text()};n[$(i).attr("id")]=a}return n},this.formatUserRoles=function(t){for(var e=$(t).find("users").find("user"),n=[],r=0;r<e.length;r++){for(var i=e[r],a=$(i).find("roles").find("role"),s=[],o=0;o<a.length;o++){var d=a[o],h={id:$(d).attr("id"),name:$(d).find("name").text(),accessId:$(d).find("access").attr("id"),access:$(d).find("access").text()};s.push(h)}var u={id:$(i).attr("id"),firstName:$(i).find("firstName").text(),lastName:$(i).find("lastName").text(),lastAccess:$(i).find("lastAccess").text(),lastAccessAppLocal:$(i).find("lastAccessAppLocal").text(),roles:s};n.push(u)}return n},this.createParameter=function(t,e){return"<"+t+">"+e+"</"+t+">"},this.createFieldParameter=function(t,e){var n="<field fid='"+t+"'";return e?e.filename?(n+=" filename='"+e.filename+"'>",n+=this.base64Encode(e.body)):(n+=">",n+=e):n+=">",n+="</field>"},this.createFidParameter=function(t,e){return"<_fid_"+t+">"+e+"</_fid_"+t+">"},this.createCSVParameter=function(t){return"<records_csv><![CDATA["+t+"]]></records_csv>"},this.base64Encode=function(t){for(var e,n,r,i,a,s,o,d="",h="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",u=0,c=t.replace(/\r\n/g,"\n"),f="",l=0;l<c.length;l++){var p=c.charCodeAt(l);128>p?f+=String.fromCharCode(p):p>127&&2048>p?(f+=String.fromCharCode(p>>6|192),f+=String.fromCharCode(63&p|128)):(f+=String.fromCharCode(p>>12|224),f+=String.fromCharCode(p>>6&63|128),f+=String.fromCharCode(63&p|128))}for(t=f;u<t.length;)e=t.charCodeAt(u++),n=t.charCodeAt(u++),r=t.charCodeAt(u++),i=e>>2,a=(3&e)<<4|n>>4,s=(15&n)<<2|r>>6,o=63&r,isNaN(n)?s=o=64:isNaN(r)&&(o=64),d=d+h.charAt(i)+h.charAt(a)+h.charAt(s)+h.charAt(o);return d},this.xmlPost=function(t,e,n){var r="/db/"+t+"?act="+e,i={url:r,data:n,dataType:"xml",type:"POST",context:this};return this.serverSide?(n.realm=this.realm,n.url=r,n.call=e,n.apptoken=this.apptoken,i.dataType="text",i.data=n,i.url="/basejs/submit"):i.contentType="text/xml",this.async||(i.async=!1),$.ajax(i).then(function(t){var t=$(t),n=t.find("errcode").text();if(0!=n){var r=t.find("errtext").text(),i=t.find("errdetail").text();return console.error("["+e+"]: "+r+" - "+i),(new $.Deferred).reject()}return t})}}function Base(t){var e=new BaseConnect(t);this.databaseId=t.databaseId,this.Table=function(t,n){this[t]=n,this.tableName=t,this.dbid=n.dbid,this.doQuery=function(n,r,i){var a=this,s=this.tableName;this.handle=function(t){return e.getRecords(s,t,"records")};var o={fmt:"structured"};if(n){var d=!isNaN(n);d?o.qid=n:o.query=n}else o.query="{'3'.XEX.''}";if(r)var h=r.clist;else var r={};if(e.config&&!h){var u=e.config.tables[s],h=[];for(t in u){var c=u[t];isNaN(c)||h.push(t)}r.clist=h.join(".")}o.clist=r.clist,o.slist=r.slist,o.options=r.options;var f={dbid:s,action:"DoQuery",params:o};return i&&(this.handle=i),e.post(f).then(function(t){return a.handle(t)})},this.find=function(t){var n=this,r=this.tableName;if(this.handle=function(t){var n=e.getRecords(r,t,"records");return n.length>0?n.length>1?n:n[0]:{}},"[object Array]"==Object.prototype.toString.call(t))var i={3:{"in":t}};else var i={3:t};return this.doQuery(i,null).then(function(t){return n.handle(t)})},this.first=function(t){var n=this,r=this.tableName;return this.handle=function(t){var n=e.getRecords(r,t,"records");return n.length>0?n[0]:{}},this.doQuery(t,null).then(function(t){return n.handle(t)})},this.last=function(t){var n=this,r=this.tableName;return this.handle=function(t){var n=e.getRecords(r,t,"records");return n.length>0?n[n.length-1]:{}},this.doQuery(t,null).then(function(t){return n.handle(t)})},this.all=function(t){var n=this,r=this.tableName;return this.handle=function(t){var n=e.getRecords(r,t,"records");return n.length>0?n:{}},this.doQuery({3:{XEX:""}},t).then(function(t){return n.handle(t)})},this.getRids=function(t){var n=this;return this.handle=function(t){return e.getRids(t)},params={clist:"3"},t||(t={3:{XEX:""}}),this.doQuery(t,params).then(function(t){return n.handle(t)})},this.doQueryCount=function(t){var n=this;this.handle=function(t){return e.getNode(t,"numMatches")};var r={dbid:this.tableName,action:"DoQueryCount",params:{query:t}};return e.post(r).then(function(t){return n.handle(t)})},this.addRecord=function(t){var n=this;this.handle=function(t){return parseInt(e.getNode(t,"rid"))};var r={dbid:this.tableName,action:"AddRecord",fieldParams:t};return e.post(r).then(function(t){return n.handle(t)})},this.editRecord=function(t,n){var r=this;this.handle=function(t){var n=e.getNode(t,"rid");return n?!0:!1};var i={dbid:this.tableName,action:"EditRecord",fieldParams:n,params:{rid:t}};return e.post(i).then(function(t){return r.handle(t)})},this.changeRecordOwner=function(t,n){var r=this;this.handle=function(){return!0};var i={dbid:this.tableName,action:"ChangeRecordOwner",params:{rid:t,newowner:n}};return e.post(i).then(function(t){return r.handle(t)})},this.copyMasterDetail=function(t){var n=this;this.handle=function(t){return e.getNode(t,"parentrid")};var r={dbid:this.tableName,action:"CopyMasterDetail",params:t};return e.post(r).then(function(t){return n.handle(t)})},this.getRecordInfo=function(t){var n=this;this.handle=function(t){for(var n={},r=$(t).find("field"),i=0;i<r.length;i++){var a=r[i],s={name:e.getNode(a,"name"),type:e.getNode(a,"type"),value:e.getNode(a,"value")};n[$(a).find("fid").text()]=s}var o={rid:e.getNode(t,"rid"),num_fields:e.getNode(t,"num_fields"),update_id:e.getNode(t,"update_id"),fields:n};return o};var r={dbid:this.tableName,action:"GetRecordInfo",params:{rid:t}};return e.post(r).then(function(t){return n.handle(t)})},this.deleteRecord=function(t){var n=this;this.handle=function(t){var n=e.getNode(t,"rid");return n?!0:!1};var r={dbid:this.tableName,action:"DeleteRecord",params:{rid:t}};return e.post(r).then(function(t){return n.handle(t)})},this.purgeRecords=function(t){var n=this;this.handle=function(t){var n=e.getNode(t,"num_records_deleted");return parseInt(n)};var r={dbid:this.tableName,action:"PurgeRecords",params:{query:t}};return e.post(r).then(function(t){return n.handle(t)})},this.importFromCSV=function(n){var r=this;this.handle=function(t){return e.getNewRids(t)};var i="",a=[];for(t in n[0])e.config&&(tableConfig=e.config.tables[this.tableName],t=tableConfig[t]),a.push(t);a=a.join(".");for(var s=0;s<n.length;s++){var o=n[s],d=[];for(t in o)value=o[t],value=value.toString().replace(/"/g,'""'),d.push('"'+value+'"');d.join(","),d+="\n",i+=d}var h={dbid:this.tableName,action:"ImportFromCSV",params:{clist:a},csvData:i};return e.post(h).then(function(t){return r.handle(t)})},this.getTableFields=function(){var t=this;this.handle=function(t){return e.getFields(t)};var n={dbid:this.tableName,action:"GetSchema"};return e.post(n).then(function(e){return t.handle(e)})},this.genAddRecordForm=function(t){var n=this;this.handle=function(t){return t};var r={dbid:this.tableName,action:"GenAddRecordForm",fidParams:t};return e.post(r).then(function(t){return n.handle(t)})},this.getNumRecords=function(){var t=this;this.handle=function(t){return parseInt(e.getNode(t,"num_records"))};var n={dbid:this.tableName,action:"GetNumRecords"};return e.post(n).then(function(e){return t.handle(e)})},this.setFieldProperties=function(t,n){var r=this;this.handle=function(t){var n=e.getNode(t,"errcode");return 0==n?!0:!1},n.fid=t;var i={dbid:this.tableName,action:"SetFieldProperties",params:n};return e.post(i).then(function(t){return r.handle(t)})},this.getTableReports=function(){var t=this;this.handle=function(t){return e.getReports(t)};var n={dbid:this.tableName,action:"GetSchema"};return e.post(n).then(function(e){return t.handle(e)})}},this.setTables=function(t){for(key in t)this[key]=new this.Table(key,t[key])},this.setTables(t.tables),this.getOneTimeTicket=function(){var t=this;this.handle=function(t){return e.getNode(t,"ticket")};var n={action:"GetOneTimeTicket"};return e.post(n).then(function(e){return t.handle(e)})},this.authenticate=function(t,n){var r=this;this.handle=function(t){return e.getNode(t,"ticket")};var i={action:"Authenticate",params:{ticket:t,hours:n}};return e.post(i).then(function(t){return r.handle(t)})},this.signOut=function(){var t=this;this.handle=function(t){var n=e.getNode(t,"errcode");return"0"==n?!0:!1};var n={action:"SignOut"};return e.post(n).then(function(e){return t.handle(e)})},this.getDBVar=function(t){var n=this;this.handle=function(t){return e.getNode(t,"value")};var r={dbid:this.databaseId,action:"GetDBvar",params:{varname:t}};return e.post(r).then(function(t){return n.handle(t)})},this.setDBVar=function(t,n){var r=this;this.handle=function(){return!0};var i={dbid:this.databaseId,action:"SetDBvar",params:{varname:t,value:n}};return e.post(i).then(function(t){return r.handle(t)})},this.uploadPage=function(t,n,r){var i=this;this.handle=function(t){return e.getNode(t,"pageID")};var a={pagetype:"1",pagebody:r};t?a.pageid=t:n&&(a.pagename=n);var s={dbid:this.databaseId,action:"AddReplaceDBPage",params:a};return e.post(s).then(function(t){return i.handle(t)})},this.deletePage=function(t){var n=this;this.handle=function(t){var n=e.getNode(t,"errcode");return"0"==n?!0:!1};var r={dbid:this.databaseId,action:"PageDelete",type:"QBI",params:{pageid:t}};return e.post(r).then(function(t){return n.handle(t)})},this.getDbPage=function(t){var n=this;this.handle=function(t){return e.getNode(t,"pagebody")};var r={dbid:this.databaseId,action:"GetDBPage",type:"API",params:{pageID:t}};return e.post(r).then(function(t){return n.handle(t)})},this.cloneDatabase=function(t){var n=this;this.handle=function(t){return e.getNode(t,"newdbid")};var r={dbid:this.databaseId,action:"CloneDatabase",type:"API",params:t};return e.post(r).then(function(t){return n.handle(t)})},this.createDatabase=function(t,n,r){var i=this;this.handle=function(t){return e.getNode(t,"dbid")};var a={action:"CreateDatabase",type:"API",params:{dbname:t,dbdesc:n,createapptoken:r||!1}};return e.post(a).then(function(t){return i.handle(t)})},this.deleteDatabase=function(){var t=this;this.handle=function(t){var n=e.getNode(t,"errcode");return"0"==n?!0:!1};var n={dbid:this.databaseId,action:"DeleteDatabase",type:"API"};return e.post(n).then(function(e){return t.handle(e)})},this.renameApp=function(t){var n=this;this.handle=function(t){var n=e.getNode(t,"errcode");return"0"==n?!0:!1};var r={dbid:this.databaseId,action:"RenameApp",type:"API",params:{newappname:t}};return e.post(r).then(function(t){return n.handle(t)})},this.findDbByName=function(t){var n=this;this.handle=function(t){return e.getNode(t,"dbid")};var r={action:"FindDBByName",type:"API",params:{dbname:t}};return e.post(r).then(function(t){return n.handle(t)})},this.getAppDtmInfo=function(){var t=this;this.handle=function(t){for(var n={},r=$(t).find("tables").find("table"),i=0;i<r.length;i++){var a=r[i],s={lastModifiedTime:$(a).find("lastModifiedTime").text(),lastRecModTime:$(a).find("lastRecModTime").text()};n[$(a).attr("id")]=s}var o={requestTime:e.getNode(t,"RequestTime"),requestNextAllowedTime:e.getNode(t,"RequestNextAllowedTime"),lastModifiedTime:e.getNode(t,"lastModifiedTime"),lastRecModTime:e.getNode(t,"lastRecModTime"),tables:n};return o};var n={action:"GetAppDTMInfo",type:"API",params:{dbid:this.databaseId}};return e.post(n).then(function(e){return t.handle(e)})},this.getDbInfo=function(){var t=this;this.handle=function(t){var n={dbname:e.getNode(t,"dbname"),lastRecModTime:e.getNode(t,"lastRecModTime"),createdTime:e.getNode(t,"createdTime"),numRecords:e.getNode(t,"numRecords"),mgrID:e.getNode(t,"mgrID"),mgrName:e.getNode(t,"mgrName"),version:e.getNode(t,"version"),time_zone:e.getNode(t,"time_zone")};return n};var n={dbid:this.databaseId,action:"GetDBInfo",type:"API"};return e.post(n).then(function(e){return t.handle(e)})},this.grantedDbs=function(t){var n=this;this.handle=function(t){for(var n=[],r=$(t).find("databases").find("dbinfo"),i=0;i<r.length;i++){var a=r[i],s={dbname:e.getNode(a,"dbname"),dbid:e.getNode(a,"dbid")};n.push(s)}return n};var r={action:"GrantedDBs",type:"API",params:t};return e.post(r).then(function(t){return n.handle(t)})},this.getUserInfo=function(t){var n=this;this.handle=function(t){var e=$(t).find("user");return e={id:$(e).attr("id"),firstName:$(e).find("firstName").text(),lastName:$(e).find("lastName").text(),login:$(e).find("login").text(),email:$(e).find("email").text(),screenName:$(e).find("screenName").text(),isVerified:$(e).find("isVerified").text(),externalAuth:$(e).find("externalAuth").text()}},t||(t="");var r={dbid:"main",action:"GetUserInfo",params:{email:t}};return e.post(r).then(function(t){return n.handle(t)})},this.getUserRoles=function(){var t=this;this.handle=function(t){return e.formatUserRoles(t)};var n={dbid:this.databaseId,action:"UserRoles"};return e.post(n).then(function(e){return t.handle(e)})},this.changeUserRole=function(t,n,r){var i=this;this.handle=function(){return!0};var a={dbid:this.databaseId,action:"ChangeUserRole",params:{userId:t,roleId:n}};return r&&(a.params.newRoleId=r),e.post(a).then(function(t){return i.handle(t)})}}var BaseHelpers={options:{timeZone:"utc",format:"hours"},inverseTables:function(t){var e={};for(var n in t){var r={};for(var i in t[n])r[t[n][i].toString()]=i;e[n]=r}return e},getUrlParam:function(t){t=t.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var e=new RegExp("[\\?&]"+t+"=([^&#]*)"),n=e.exec(location.search);return null==n?"":decodeURIComponent(n[1].replace(/\+/g," "))},formatDateElement:function(t){return t=t.toString(),1==t.length&&(t="0"+t),t},dateToString:function(t){if(t){var e=new Date(parseInt(t)),n=this.formatDateElement(e.getUTCMonth()+1),r=this.formatDateElement(e.getUTCDate());return e=[n,r,e.getUTCFullYear()].join("-")}return" "},dateTimeToString:function(t,e){var n=new Date,e=e?e.toLowerCase().trim():this.options.timeZone.toLowerCase();Date.prototype.stdTimezoneOffset=function(){var t=new Date(this.getFullYear(),0,1),e=new Date(this.getFullYear(),6,1);return Math.max(t.getTimezoneOffset(),e.getTimezoneOffset())},Date.prototype.dst=function(){return this.getTimezoneOffset()<this.stdTimezoneOffset()};var r={utc:0,eastern:n.dst()?-4:-5,central:n.dst()?-5:-6,mountain:n.dst()?-6:-7,pacific:n.dst()?-7:-8},i=r[e];if(t){var a=new Date(parseInt(t)+36e5*i),s=(this.formatDateElement(a.getUTCFullYear),this.formatDateElement(a.getUTCMonth()+1)),o=this.formatDateElement(a.getUTCDate()),d=this.formatDateElement(a.getUTCHours()),h=this.formatDateElement(a.getUTCMinutes()),u=(this.formatDateElement(a.getUTCSeconds()),[s,o,a.getUTCFullYear()].join("-")),c=parseInt(d)>=12?"PM":"AM";return d%=12,d=d?d:12,u+=" ",u+=[d,h].join(":"),u+=" "+c}return""},durationToString:function(t,e){var n,r=parseInt(t),e=e?e.trim().toLowerCase():this.options.format.toLowerCase(),i={days:function(){return r/864e5},hours:function(){return r/36e5},minutes:function(){return r/6e4},seconds:function(){return r/1e3}};return t?(i[e]?n=i[e]():(n=i.hours(),console.log("The format parameter passed to BaseHelpers.durationToString() was incorrect. Using the format for 'hours' instead.")),n=Math.round(100*n)/100,n.toString()):""},timeOfDayToString:function(t){var e="";e=new Date,e.setHours(""),e.setMinutes(""),e.setSeconds(""),e.setMilliseconds(t);var n=e.getHours().toString(),r=e.getMinutes().toString(),i=n>12?"pm":"am";return n%=12,n=n?n:12,r=r.length>1?r:"0"+r,e=n+":"+r+" "+i},redirectToEditForm:function(t,e){window.location="/db/"+t+"?a=er&rid="+e},redirectToViewForm:function(t,e){window.location="/db/"+t+"?a=dr&rid="+e},downloadFile:function(t,e,n,r){var r=r||0;window.location="https://www.quickbase.com/up/"+t+"/a/r"+e+"/e"+n+"/v"+r}};